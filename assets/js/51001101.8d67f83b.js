"use strict";(self.webpackChunkmetro_website=self.webpackChunkmetro_website||[]).push([[6645],{68459:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>m,toc:()=>c});var a=n(87462),o=n(63366),i=(n(67294),n(3905)),r=["components"],s={id:"caching",title:"Caching"},l=void 0,m={unversionedId:"caching",id:"caching",title:"Caching",description:"Out of the box, Metro speeds up builds using a local cache of transformed modules. Thanks to this cache, Metro doesn't need to retransform modules unless the source code (or current configuration) has changed since the last time they were transformed.",source:"@site/../docs/Caching.md",sourceDirName:".",slug:"/caching",permalink:"/docs/caching",draft:!1,editUrl:"https://github.com/facebook/metro/edit/main/docs/../docs/Caching.md",tags:[],version:"current",lastUpdatedAt:1730485694,formattedLastUpdatedAt:"Nov 1, 2024",frontMatter:{id:"caching",title:"Caching"},sidebar:"docs",previous:{title:"Bundle Formats",permalink:"/docs/bundling"},next:{title:"Module Resolution",permalink:"/docs/resolution"}},d={},c=[{value:"Built-in cache stores",id:"built-in-cache-stores",level:2},{value:"Custom cache stores",id:"custom-cache-stores",level:2}],p={toc:c},h="wrapper";function u(e){var t=e.components,n=(0,o.Z)(e,r);return(0,i.mdx)(h,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.mdx)("p",null,"Out of the box, Metro speeds up builds using a ",(0,i.mdx)("strong",{parentName:"p"},"local cache")," of ",(0,i.mdx)("a",{parentName:"p",href:"/docs/concepts#transformation"},"transformed")," modules. Thanks to this cache, Metro doesn't need to retransform modules unless the source code (or current configuration) has changed since the last time they were transformed."),(0,i.mdx)("p",null,"Metro also has the ability to use a ",(0,i.mdx)("strong",{parentName:"p"},"remote cache"),". This can dramatically speed up builds for larger teams and/or larger codebases by reducing the amount of time spent locally building remote changes even further. For example, this is how we use Metro to build React Native apps at Meta (a codebase with many thousands of files and hundreds of daily active engineers)."),(0,i.mdx)("p",null,"A typical setup for a remote cache involves:"),(0,i.mdx)("ol",null,(0,i.mdx)("li",{parentName:"ol"},"A storage backend specific to your team (e.g."," ",(0,i.mdx)("a",{parentName:"li",href:"https://internalfb.com/sevmanager/view/3"},"S3")," ","bucket)."),(0,i.mdx)("li",{parentName:"ol"},"Running ",(0,i.mdx)("a",{parentName:"li",href:"/docs/cli#build-entry"},(0,i.mdx)("inlineCode",{parentName:"a"},"metro build"))," periodically (e.g. in a CI job) to populate the cache, using ",(0,i.mdx)("inlineCode",{parentName:"li"},"HttpStore")," (or a custom read/write cache store) in your Metro config."),(0,i.mdx)("li",{parentName:"ol"},"Configuring Metro on your development machines to read from the cache, using ",(0,i.mdx)("inlineCode",{parentName:"li"},"HttpGetStore")," (or a custom read-only cache store) in your Metro config.")),(0,i.mdx)("p",null,"The main option for configuring the Metro cache is ",(0,i.mdx)("a",{parentName:"p",href:"/docs/configuration#cachestores"},(0,i.mdx)("inlineCode",{parentName:"a"},"cacheStores")),". Typically, the local cache (e.g. ",(0,i.mdx)("inlineCode",{parentName:"p"},"FileStore"),") should be listed first, followed by the remote cache (e.g. ",(0,i.mdx)("inlineCode",{parentName:"p"},"HttpCache"),")."),(0,i.mdx)("h2",{id:"built-in-cache-stores"},"Built-in cache stores"),(0,i.mdx)("p",null,"Metro provides a number of built-in cache store implementations for use with the ",(0,i.mdx)("a",{parentName:"p",href:"/docs/configuration#cachestores"},(0,i.mdx)("inlineCode",{parentName:"a"},"cacheStores"))," config option:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"FileStore({root: string})"))," will store cache entries as files under the directory specified by ",(0,i.mdx)("inlineCode",{parentName:"li"},"root"),"."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"AutoCleanFileStore()"))," is a ",(0,i.mdx)("inlineCode",{parentName:"li"},"FileStore")," that periodically cleans up old entries. It accepts the same options as ",(0,i.mdx)("inlineCode",{parentName:"li"},"FileStore")," plus the following:",(0,i.mdx)("ul",{parentName:"li"},(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.intervalMs: number"))," is the time in milliseconds between cleanup attempts. Defaults to 10 minutes."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.cleanupThresholdMs: number"))," is the minimum time in milliseconds since the last modification of an entry before it can be deleted. Defaults to 3 days."))),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"HttpStore(options)"))," is a bare-bones remote cache client that reads (",(0,i.mdx)("inlineCode",{parentName:"li"},"GET"),") and writes (",(0,i.mdx)("inlineCode",{parentName:"li"},"PUT"),") compressed cache artifacts over HTTP or HTTPS.",(0,i.mdx)("ul",{parentName:"li"},(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.endpoint: string"))," is the base URL for the cache server. For example, an ",(0,i.mdx)("inlineCode",{parentName:"li"},"HttpStore")," with ",(0,i.mdx)("inlineCode",{parentName:"li"},"'http://www.example.com/endpoint'")," as the endpoint would issue requests to URLs such as ",(0,i.mdx)("inlineCode",{parentName:"li"},"http://www.example.com/endpoint/c083bff944879d9f528cf185eba0f496bc10a47d"),"."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.timeout: number"))," is the timeout for requests to the cache server, in milliseconds. Defaults to 5000."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.family: 4 | 6"))," is the same as the ",(0,i.mdx)("inlineCode",{parentName:"li"},"family")," parameter to Node's ",(0,i.mdx)("a",{parentName:"li",href:"https://nodejs.org/api/http.html#httprequesturl-options-callback"},(0,i.mdx)("inlineCode",{parentName:"a"},"http.request")),"."),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"options.cert"),", ",(0,i.mdx)("inlineCode",{parentName:"strong"},"options.ca"),", ",(0,i.mdx)("inlineCode",{parentName:"strong"},"options.key")),": HTTPS options passed directly to ",(0,i.mdx)("a",{parentName:"li",href:"https://nodejs.org/api/https.html"},"Node's built-in HTTPS client"),"."))),(0,i.mdx)("li",{parentName:"ul"},(0,i.mdx)("strong",{parentName:"li"},(0,i.mdx)("inlineCode",{parentName:"strong"},"HttpGetStore(options)"))," is a read-only version of ",(0,i.mdx)("inlineCode",{parentName:"li"},"HttpStore"),".")),(0,i.mdx)("p",null,"You can import these classes from the ",(0,i.mdx)("inlineCode",{parentName:"p"},"metro-cache")," package or get them through the function form of ",(0,i.mdx)("inlineCode",{parentName:"p"},"cacheStores"),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-js"},"// metro.config.js\nconst os = require('node:os');\nconst path = require('node:path');\n\nmodule.exports = {\n  cacheStores: ({ FileStore }) => [\n    new FileStore({\n      root: path.join(os.tmpdir(), 'metro-cache'),\n    }),\n  ],\n};\n\n")),(0,i.mdx)("h2",{id:"custom-cache-stores"},"Custom cache stores"),(0,i.mdx)("p",null,"To implement a custom cache store, pass an instance of a class with the following interface into ",(0,i.mdx)("a",{parentName:"p",href:"/docs/configuration#cachestores"},(0,i.mdx)("inlineCode",{parentName:"a"},"cacheStores")),":"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre",className:"language-flow"},"interface CacheStore<T: Buffer | JsonSerializable> {\n  // Read an entry from the cache. Returns `null` if not found.\n  get(key: Buffer): ?T | Promise<?T>;\n\n  // Write an entry to the cache (if writable) or do nothing (if read-only)\n  set(key: Buffer, value: T): void | Promise<void>;\n\n  // Clear the cache (if possible) or do nothing\n  clear(): void | Promise<void>;\n}\n\ntype JsonSerializable = /* Any JSON-serializable value */;\n")),(0,i.mdx)("p",null,"The value of a cache entry is either an instance of ",(0,i.mdx)("a",{parentName:"p",href:"https://nodejs.org/api/buffer.html#buffer"},(0,i.mdx)("inlineCode",{parentName:"a"},"Buffer"))," or a JSON-serializable value (with unspecified internal structure in both cases). For a given cache key, ",(0,i.mdx)("inlineCode",{parentName:"p"},"get()")," ",(0,i.mdx)("em",{parentName:"p"},"must")," return the same type of value that was originally provided to ",(0,i.mdx)("inlineCode",{parentName:"p"},"set()"),"."))}u.isMDXComponent=!0}}]);